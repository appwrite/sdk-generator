<?php

namespace {{ spec.title | caseUcfirst }}\Services;

require_once './vendor/autoload.php';

use {{ spec.title | caseUcfirst }}\Client;
use Utopia\CLI\CLI;
use Utopia\Validator\Mock;
use Utopia\CLI\Console;

$client = new Client();
$cli = new CLI();

$cli->
      init(function() use ($cli) {
        
        if (array_key_exists('help', $cli->getArgs())) {
            $taskName = $cli->match()->getName();
            $task = $cli->getTasks()[$taskName];
            $description = $task->getLabel('description', '');
            $params = $task->getParams();

            Console::log("\e[0;31;m {{ language.params.logo | raw }} \e[0m") ;

            printf("\nUsage : {{ language.params.executableName }} client {$taskName} --[OPTIONS] \n\n");
            printf($description);
            printf("Options:\n");
            $mask = "\t%-20.20s %-125.125s\n";

            foreach ($params as $key => $value) {
                if ($key !== 'help')
                    printf($mask, $key, $value['description']);
            }
            Console::exit(0);
        }
      });

$cli
    ->task('setEndpoint')
    ->param('endpoint', '', new Mock(), 'Your {{ spec.title | title }} endpoint', false)
    ->action(function($endpoint) use ($client) {
        $client->setPreference('endpoint', $endpoint);
        $result = $client->savePreferences();
        if ($result === false) {
            Console::error('âŒ Could not save preferences.');
        } else {
            Console::success('âœ… Preferences saved successfully');
        }
    });


{% for header in spec.global.headers %}
$cli
    ->task('set{{ header.key }}')
    ->param('{{ header.key | lower }}', '', new Mock(), '{{ header.description }}', false)
    ->action(function(${{ header.key | lower }}) use ($client) {
        $client->setPreference('{{ header.name }}', ${{ header.key | lower }});
        $result = $client->savePreferences();
        if ($result === false) {
            Console::error('âŒ Could not save preferences.');
        } else {
            Console::success('âœ… Preferences saved successfully');
        }
    });

{% endfor %}

$cli
    ->task('version')
    ->action(function() {
       Console::log('CLI Version : {{ sdk.version }}');
       Console::log('Server Version : {{ spec.version | url_encode }}');
    });


$cli
    ->task('help')
    ->action(function() {
        Console::log("\e[0;31;m {{ language.params.logo | raw }} \e[0m") ;
        printf("\nUsage : {{ language.params.executableName }} client [COMMAND]\n\n");
        printf("Commands :\n");
        $mask = "\t%-20.20s %-125.125s\n";
        printf($mask, "setEndpoint", "Set your server endpoint.");
        printf($mask, "setProject", "Set the project you want to connect to.");
        printf($mask, "setKey", "Set the API key for the project.");
        printf($mask, "setLocale", "Set your preferred locale (eg: en-US).");
        printf("\nRun '{{ language.params.executableName }} client COMMAND --help' for more information on a command.\n");
    });
    

$cli->run();
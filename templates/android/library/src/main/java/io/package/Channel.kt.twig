package {{ sdk.namespace | caseDot }}

// The result of building the channel.
class ResolvedChannel(private val value: String) {
    override fun toString(): String {
        return value
    }
}

// Helper for normalizing IDs
private fun normalize(id: String): String {
    val trimmed = id.trim()
    return if (trimmed.isEmpty()) "*" else trimmed
}

// Interface for actionable channels
interface Actionable {
    val channel: String
    fun create(): ResolvedChannel
    fun update(): ResolvedChannel
    fun delete(): ResolvedChannel
}

interface IDatabase {
    fun collection(id: String = "*"): ICollection
}

interface ICollection {
    fun document(id: String = "*"): IDocument
}

interface IDocument : Actionable

interface ITablesDB {
    fun table(id: String = "*"): ITable
}

interface ITable {
    fun row(id: String = "*"): IRow
}

interface IRow : Actionable

interface IBucket {
    fun file(id: String = "*"): IFile
}

interface IFile : Actionable

interface IFunction {
    fun execution(id: String = "*"): IExecution
}

interface IExecution : Actionable

private class ChannelBuilder(
    private val segments: List<String>
) : IDatabase, ICollection, IDocument,
    ITablesDB, ITable, IRow,
    IBucket, IFile,
    IFunction, IExecution, Actionable {

    companion object {
        fun start(segments: List<String>) = ChannelBuilder(segments)
    }

    private fun next(segment: String, id: String): ChannelBuilder {
        return ChannelBuilder(segments + listOf(segment, normalize(id)))
    }

    override fun collection(id: String): ICollection =
        next("collections", id)

    override fun document(id: String): IDocument =
        next("documents", id)

    override fun table(id: String): ITable =
        next("tables", id)

    override fun row(id: String): IRow =
        next("rows", id)

    override fun file(id: String): IFile =
        next("files", id)

    override fun execution(id: String): IExecution =
        next("executions", id)

    override val channel: String
        get() = segments.joinToString(".")

    override fun create(): ResolvedChannel =
        ResolvedChannel("$channel.create")

    override fun update(): ResolvedChannel =
        ResolvedChannel("$channel.update")

    override fun delete(): ResolvedChannel =
        ResolvedChannel("$channel.delete")

    override fun toString(): String = channel
}

class Channel private constructor() {

    companion object {

        fun database(id: String = "*"): IDatabase =
            ChannelBuilder.start(listOf("databases", normalize(id)))

        fun tablesdb(id: String = "*"): ITablesDB =
            ChannelBuilder.start(listOf("tablesdb", normalize(id)))

        fun buckets(id: String = "*"): IBucket =
            ChannelBuilder.start(listOf("buckets", normalize(id)))

        fun functions(id: String = "*"): IFunction =
            ChannelBuilder.start(listOf("functions", normalize(id)))

        fun teams(id: String = "*"): Actionable =
            ChannelBuilder.start(listOf("teams", normalize(id)))

        fun memberships(id: String = "*"): Actionable =
            ChannelBuilder.start(listOf("memberships", normalize(id)))

        fun account(userId: String = ""): String {
            val id = normalize(userId)
            return if (id == "*") "account" else "account.$id"
        }

        // Global events
        const val documents = "documents"
        const val rows = "rows"
        const val files = "files"
        const val executions = "executions"
    }
}

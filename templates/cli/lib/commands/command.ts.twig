import fs = require('fs');
import pathLib = require('path');
import tar = require('tar');
import ignore from 'ignore';
import { promisify } from 'util';
import Client from '../client';
import { getAllFiles, showConsoleLink } from '../utils';
import { Command } from 'commander';
import { sdkForProject, sdkForConsole } from '../sdks';
import { parse, actionRunner, parseInteger, parseBool, commandDescriptions, success, log, warn } from '../parser';
import { localConfig, globalConfig } from '../config';
import { File } from 'undici';
import { ReadableStream } from 'stream/web';
import type { UploadProgress, FileUpload } from '../types';
{% set addedEnums = [] %}
{% for method in service.methods %}
{% for parameter in method.parameters.all %}
{% if parameter.enumValues is not empty %}
{% if parameter.enumName not in addedEnums %}
import { {{ parameter.enumName | caseUcfirst }} } from '../enums/{{ parameter.enumName | caseKebab }}';
{% set addedEnums = addedEnums|merge([parameter.enumName]) %}
{% endif %}
{% endif %}
{% endfor %}
{% endfor %}

function convertReadStreamToReadableStream(readStream: fs.ReadStream): ReadableStream {
  return new ReadableStream({
    start(controller) {
      readStream.on("data", (chunk: Buffer) => {
        controller.enqueue(chunk);
      });
      readStream.on("end", () => {
        controller.close();
      });
      readStream.on("error", (err: Error) => {
        controller.error(err);
      });
    },
    cancel() {
      readStream.destroy();
    },
  });
}

export const {{ service.name }} = new Command("{{ service.name | caseKebab }}").description(commandDescriptions['{{ service.name | caseKebab }}'] ?? '').configureHelp({
    helpWidth: process.stdout.columns || 80
})

{% for method in service.methods %}
{% set commandNameLower = (method.name | caseKebab | lower) %}
{# Check if this method should be skipped (is deprecated and has a non-deprecated duplicate) #}
{% set shouldSkip = false %}
{% if method.deprecated %}
{% for otherMethod in service.methods %}
{% if not otherMethod.deprecated and (otherMethod.name | caseKebab | lower) == commandNameLower %}
{% set shouldSkip = true %}
{% endif %}
{% endfor %}
{% endif %}
{% if not shouldSkip %}
interface {{ service.name | caseUcfirst }}{{ method.name | caseUcfirst }}RequestParams {
{% for parameter in method.parameters.all %}
    {{ parameter.name | caseCamel | escapeKeyword }}{% if not parameter.required %}?{% endif %}: {{ parameter | typeName }};
{% endfor %}
    overrideForCli?: boolean;
    parseOutput?: boolean;
    sdk?: Client;
{% if 'multipart/form-data' in method.consumes %}
    onProgress?: (progress: UploadProgress) => void;
{% endif %}
{% if method.type == 'location' %}
    destination?: string;
{% endif %}
{% if hasConsolePreview(method.name,service.name) %}
    console?: boolean;
{% endif %}
}

{% block declaration %}
export const {{ service.name }}{{ method.name | caseUcfirst }} = async ({
        {%- for parameter in method.parameters.all -%}
            {{ parameter.name | caseCamel | escapeKeyword }},
        {%- endfor -%}

        {%- block baseParams -%}parseOutput = true, overrideForCli = false, sdk = undefined {%- endblock -%}

        {%- if 'multipart/form-data' in method.consumes -%},onProgress = (progress: any) => {}{%- endif -%}

        {%- if method.type == 'location' -%}, destination{%- endif -%}
        {% if hasConsolePreview(method.name,service.name) %}, console: showConsole{%- endif -%}
}: {{ service.name | caseUcfirst }}{{ method.name | caseUcfirst }}RequestParams): Promise<any> => {
    let client = !sdk ? await {% if service.name == "projects" %}sdkForConsole(){% else %}sdkForProject(){% endif %} :
    sdk;
    let apiPath = '{{ method.path }}'{% for parameter in method.parameters.path %}.replace('{{ '{' }}{{ parameter.name | caseCamel }}{{ '}' }}', {{ parameter.name | caseCamel | escapeKeyword }}){% endfor %};
{{ include ('cli/base/params.twig') }}
{% if 'multipart/form-data' in method.consumes %}
{{ include ('cli/base/requests/file.twig') }}{% else %}
{{ include('cli/base/requests/api.twig') }}
{% endif %}
}
{% endblock declaration %}
{% endif %}
{% endfor %}
{% set processedCommands = [] %}
{% for method in service.methods %}
{% set commandName = method.name | caseKebab %}
{% set commandNameLower = commandName | lower %}
{# Check if this command name (in lowercase) has already been processed by a non-deprecated method #}
{% set shouldSkip = false %}
{% if method.deprecated %}
{% for otherMethod in service.methods %}
{% if not otherMethod.deprecated and (otherMethod.name | caseKebab | lower) == commandNameLower %}
{% set shouldSkip = true %}
{% endif %}
{% endfor %}
{% endif %}
{% if not shouldSkip %}
{% set processedCommands = processedCommands|merge([commandNameLower]) %}
{{ service.name }}
    .command(`{{ method.name | caseKebab }}`)
{% autoescape false %}
    .description(`{% if method.deprecated %}[**DEPRECATED** - This command is deprecated.{% if method.replaceWith %} Please use '{{ method.replaceWith | replace({'.': ' '}) | caseKebab }}' instead{% endif %}] {% endif %}{{ method.description | replace({'`':'\''}) | replace({'\n':' '}) | replace({'\n \n':' '}) }}`)
{% for parameter in method.parameters.all %}
    .{% if parameter.required and not parameter.nullable %}requiredOption{% else %}option{% endif %}(`--{{ parameter.name | escapeKeyword | caseKebab }}{% if parameter | typeName == 'boolean' %} [value]{% else %} {% if parameter.array.type|length > 0 %}[{% else %}<{% endif %}{{ parameter.name | escapeKeyword | caseKebab }}{% if parameter.array.type|length > 0 %}...{% endif %}{% if parameter.array.type|length > 0 %}]{% else %}>{% endif %}{% endif %}`, `{{ parameter.description | replace({'`':'\''}) | replace({'\n':' '}) | replace({'\n \n':' '}) }}`{% if parameter | typeName == 'boolean' %}, (value: string | undefined) => value === undefined ? true : parseBool(value){% elseif parameter | typeName == 'number' %}, parseInteger{% endif %})
{% endfor %}
{% if method.type == 'location' %}
    .requiredOption(`--destination <path>`, `output file path.`)
{% endif %}
{% if hasConsolePreview(method.name,service.name) %}
    .option(`--console`, `Get the resource console url`)
{% endif %}
{% endautoescape %}
    .action(actionRunner({{ service.name }}{{ method.name | caseUcfirst }}))

{% endif %}
{% endfor %}


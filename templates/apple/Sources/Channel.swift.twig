import Foundation

// The result of building the channel.
public final class ResolvedChannel {
    private let value: String

    init(value: String) {
        self.value = value
    }

    public func toString() -> String {
        value
    }
}

// Helper for normalizing IDs
private func normalize(_ id: String) -> String {
    let trimmed = id.trimmingCharacters(in: .whitespacesAndNewlines)
    return trimmed.isEmpty ? "*" : trimmed
}

// Protocol for actionable channels
public protocol Actionable {
    var channel: String { get }
    func create() -> ResolvedChannel
    func update() -> ResolvedChannel
    func delete() -> ResolvedChannel
}

// Base actionable channel
open class ActionChannel: Actionable {
    let base: String
    
    public var channel: String {
        return base
    }

    init(base: String) {
        self.base = base
    }

    public func create() -> ResolvedChannel {
        ResolvedChannel(value: "\(base).create")
    }

    public func update() -> ResolvedChannel {
        ResolvedChannel(value: "\(base).update")
    }

    public func delete() -> ResolvedChannel {
        ResolvedChannel(value: "\(base).delete")
    }

    public func toString() -> String {
        base
    }
}

// Database → Collection → Document

public final class DocumentChannel: ActionChannel {}

public final class CollectionChannel {
    private let base: String
    private let databaseId: String
    private let collectionId: String

    init(databaseId: String, collectionId: String) {
        self.databaseId = normalize(databaseId)
        self.collectionId = normalize(collectionId)
        self.base = "databases.\(self.databaseId).collections.\(self.collectionId)"
    }

    public func document(_ documentId: String = "*") -> DocumentChannel {
        DocumentChannel(base: "\(base).documents.\(normalize(documentId))")
    }

    public func toString() -> String {
        base
    }
}

public final class DatabaseChannel {
    private let base: String
    private let databaseId: String

    init(databaseId: String) {
        self.databaseId = normalize(databaseId)
        self.base = "databases.\(self.databaseId)"
    }

    public func collection(_ collectionId: String = "*") -> CollectionChannel {
        CollectionChannel(databaseId: databaseId, collectionId: collectionId)
    }

    public func toString() -> String {
        base
    }
}

// TablesDB → Table → Row

public final class RowChannel: ActionChannel {}

public final class TableChannel {
    private let base: String
    private let databaseId: String
    private let tableId: String

    init(databaseId: String, tableId: String) {
        self.databaseId = normalize(databaseId)
        self.tableId = normalize(tableId)
        self.base = "tablesdb.\(self.databaseId).tables.\(self.tableId)"
    }

    public func row(_ rowId: String = "*") -> RowChannel {
        RowChannel(base: "\(base).rows.\(normalize(rowId))")
    }

    public func toString() -> String {
        base
    }
}

public final class TablesDBChannel {
    private let base: String
    private let databaseId: String

    init(databaseId: String) {
        self.databaseId = normalize(databaseId)
        self.base = "tablesdb.\(self.databaseId)"
    }

    public func table(_ tableId: String = "*") -> TableChannel {
        TableChannel(databaseId: databaseId, tableId: tableId)
    }

    public func toString() -> String {
        base
    }
}

// Buckets → File

public final class FileChannel: ActionChannel {}

public final class BucketChannel {
    private let base: String
    private let bucketId: String

    init(bucketId: String) {
        self.bucketId = normalize(bucketId)
        self.base = "buckets.\(self.bucketId)"
    }

    public func file(_ fileId: String = "*") -> FileChannel {
        FileChannel(base: "\(base).files.\(normalize(fileId))")
    }

    public func toString() -> String {
        base
    }
}

// Functions → Execution

public final class ExecutionChannel: ActionChannel {}

public final class FunctionChannel {
    private let base: String
    private let functionId: String

    init(functionId: String) {
        self.functionId = normalize(functionId)
        self.base = "functions.\(self.functionId)"
    }

    public func execution(_ executionId: String = "*") -> ExecutionChannel {
        ExecutionChannel(base: "\(base).executions.\(normalize(executionId))")
    }

    public func toString() -> String {
        base
    }
}

// Teams & Memberships

public final class TeamChannel: ActionChannel {
    init(teamId: String = "*") {
        super.init(base: "teams.\(normalize(teamId))")
    }
}

public final class MembershipChannel: ActionChannel {
    init(membershipId: String = "*") {
        super.init(base: "memberships.\(normalize(membershipId))")
    }
}

// Entry point

public final class Channel {

    public static func database(_ databaseId: String = "*") -> DatabaseChannel {
        DatabaseChannel(databaseId: databaseId)
    }

    public static func tablesdb(_ databaseId: String = "*") -> TablesDBChannel {
        TablesDBChannel(databaseId: databaseId)
    }

    public static func buckets(_ bucketId: String = "*") -> BucketChannel {
        BucketChannel(bucketId: bucketId)
    }

    public static func functions(_ functionId: String = "*") -> FunctionChannel {
        FunctionChannel(functionId: functionId)
    }

    public static func teams(_ teamId: String = "*") -> TeamChannel {
        TeamChannel(teamId: teamId)
    }

    public static func memberships(_ membershipId: String = "*") -> MembershipChannel {
        MembershipChannel(membershipId: membershipId)
    }

    public static func account(_ userId: String = "") -> String {
        let normalized = normalize(userId)
        return normalized == "*" ? "account" : "account.\(normalized)"
    }

    // Global events

    public static let documents = "documents"
    public static let rows = "rows"
    public static let files = "files"
    public static let executions = "executions"
}

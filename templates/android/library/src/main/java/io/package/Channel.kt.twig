package {{ sdk.namespace | caseDot }}

// The result of building the channel.
class ResolvedChannel(private val value: String) {
    override fun toString(): String {
        return value
    }
}

// Helper for normalizing IDs
private fun normalize(id: String): String {
    val trimmed = id.trim()
    return if (trimmed.isEmpty()) "*" else trimmed
}

// Interface for actionable channels
interface Actionable {
    val channel: String
    fun create(): ResolvedChannel
    fun update(): ResolvedChannel
    fun delete(): ResolvedChannel
}

// Base actionable channel
abstract class ActionChannel(protected val base: String) : Actionable {

    override val channel: String
        get() = base

    override fun create(): ResolvedChannel {
        return ResolvedChannel("$base.create")
    }

    override fun update(): ResolvedChannel {
        return ResolvedChannel("$base.update")
    }

    override fun delete(): ResolvedChannel {
        return ResolvedChannel("$base.delete")
    }

    override fun toString(): String {
        return base
    }
}

// Database → Collection → Document

class DocumentChannel(base: String) : ActionChannel(base)

class CollectionChannel(
    databaseId: String,
    collectionId: String
) {
    private val base =
        "databases.${normalize(databaseId)}.collections.${normalize(collectionId)}"

    fun document(documentId: String = "*"): DocumentChannel {
        return DocumentChannel("$base.documents.${normalize(documentId)}")
    }

    override fun toString(): String {
        return base
    }
}

class DatabaseChannel(databaseId: String) {
    private val databaseId = normalize(databaseId)
    private val base = "databases.$databaseId"

    fun collection(collectionId: String = "*"): CollectionChannel {
        return CollectionChannel(databaseId, collectionId)
    }

    override fun toString(): String {
        return base
    }
}

// TablesDB → Table → Row

class RowChannel(base: String) : ActionChannel(base)

class TableChannel(
    databaseId: String,
    tableId: String
) {
    private val base =
        "tablesdb.${normalize(databaseId)}.tables.${normalize(tableId)}"

    fun row(rowId: String = "*"): RowChannel {
        return RowChannel("$base.rows.${normalize(rowId)}")
    }

    override fun toString(): String {
        return base
    }
}

class TablesDBChannel(databaseId: String) {
    private val databaseId = normalize(databaseId)
    private val base = "tablesdb.$databaseId"

    fun table(tableId: String = "*"): TableChannel {
        return TableChannel(databaseId, tableId)
    }

    override fun toString(): String {
        return base
    }
}

// Buckets → File

class FileChannel(base: String) : ActionChannel(base)

class BucketChannel(bucketId: String) {
    private val bucketId = normalize(bucketId)
    private val base = "buckets.$bucketId"

    fun file(fileId: String = "*"): FileChannel {
        return FileChannel("$base.files.${normalize(fileId)}")
    }

    override fun toString(): String {
        return base
    }
}

// Functions → Execution

class ExecutionChannel(base: String) : ActionChannel(base)

class FunctionChannel(functionId: String) {
    private val functionId = normalize(functionId)
    private val base = "functions.$functionId"

    fun execution(executionId: String = "*"): ExecutionChannel {
        return ExecutionChannel("$base.executions.${normalize(executionId)}")
    }

    override fun toString(): String {
        return base
    }
}

// Teams & Memberships

class TeamChannel(teamId: String = "*") :
    ActionChannel("teams.${normalize(teamId)}")

class MembershipChannel(membershipId: String = "*") :
    ActionChannel("memberships.${normalize(membershipId)}")

// Entry point

class Channel {
    companion object {

        fun database(databaseId: String = "*"): DatabaseChannel {
            return DatabaseChannel(databaseId)
        }

        fun tablesdb(databaseId: String = "*"): TablesDBChannel {
            return TablesDBChannel(databaseId)
        }

        fun buckets(bucketId: String = "*"): BucketChannel {
            return BucketChannel(bucketId)
        }

        fun functions(functionId: String = "*"): FunctionChannel {
            return FunctionChannel(functionId)
        }

        fun teams(teamId: String = "*"): TeamChannel {
            return TeamChannel(teamId)
        }

        fun memberships(membershipId: String = "*"): MembershipChannel {
            return MembershipChannel(membershipId)
        }

        fun account(userId: String = ""): String {
            val normalized = normalize(userId)
            return if (normalized == "*") "account" else "account.$normalized"
        }

        // Global events

        const val documents = "documents"
        const val rows = "rows"
        const val files = "files"
        const val executions = "executions"
    }
}

package {{ sdk.namespace | caseDot }}

// Marker interfaces for type safety
internal interface _Root
internal interface _Database
internal interface _Collection
internal interface _Document
internal interface _TablesDB
internal interface _Table
internal interface _Row
internal interface _Bucket
internal interface _File
internal interface _Func
internal interface _Execution
internal interface _Team
internal interface _Membership
internal interface _Resolved

// Union type for actionable channels
typealias Actionable = _Document

/**
 * Helper for normalizing IDs
 */
private fun normalize(id: String): String {
    val trimmed = id.trim()
    return if (trimmed.isEmpty()) "*" else trimmed
}

/**
 * Channel class with generic type parameter for type-safe method chaining
 */
class Channel<out T> private constructor(
    private val segments: List<String>
) {
    /**
     * Internal helper to transition to next state with segment and ID
     * Public for extension function access
     */
    fun <N> next(segment: String, id: String = "*"): Channel<N> {
        return Channel(segments + listOf(segment, normalize(id)))
    }

    /**
     * Internal helper for terminal actions (no ID segment)
     * Public for extension function access
     */
    fun resolve(action: String): Channel<_Resolved> {
        return Channel(segments + listOf(action))
    }

    /**
     * Convert channel to string representation
     */
    override fun toString(): String = segments.joinToString(".")

    companion object {
        fun database(id: String = "*"): Channel<_Database> =
            Channel(listOf("databases", normalize(id)))

        fun tablesdb(id: String = "*"): Channel<_TablesDB> =
            Channel(listOf("tablesdb", normalize(id)))

        fun bucket(id: String = "*"): Channel<_Bucket> =
            Channel(listOf("buckets", normalize(id)))

        fun function(id: String = "*"): Channel<_Func> =
            Channel(listOf("functions", normalize(id)))

        fun team(id: String = "*"): Channel<_Team> =
            Channel(listOf("teams", normalize(id)))

        fun membership(id: String = "*"): Channel<_Membership> =
            Channel(listOf("memberships", normalize(id)))

        fun account(userId: String = ""): String {
            val id = normalize(userId)
            return if (id == "*") "account" else "account.$id"
        }

        // Global events
        const val documents = "documents"
        const val rows = "rows"
        const val files = "files"
        const val executions = "executions"
    }
}

// --- DATABASE ROUTE ---
// Extension functions restricted by receiver type

/**
 * Only available on Channel<_Database>
 */
fun Channel<_Database>.collection(id: String = "*"): Channel<_Collection> =
    this.next("collections", id)

/**
 * Only available on Channel<_Collection>
 */
fun Channel<_Collection>.document(id: String = "*"): Channel<_Document> =
    this.next("documents", id)

// --- TABLESDB ROUTE ---

/**
 * Only available on Channel<_TablesDB>
 */
fun Channel<_TablesDB>.table(id: String = "*"): Channel<_Table> =
    this.next("tables", id)

/**
 * Only available on Channel<_Table>
 */
fun Channel<_Table>.row(id: String = "*"): Channel<_Row> =
    this.next("rows", id)

// --- BUCKET ROUTE ---

/**
 * Only available on Channel<_Bucket>
 */
fun Channel<_Bucket>.file(id: String = "*"): Channel<_File> =
    this.next("files", id)

// --- FUNCTION ROUTE ---

/**
 * Only available on Channel<_Func>
 */
fun Channel<_Func>.execution(id: String = "*"): Channel<_Execution> =
    this.next("executions", id)

// --- TERMINAL ACTIONS ---
// Restricted to Actionable types (_Document, _Row, _File, _Execution, _Team, _Membership)

/**
 * Only available on Channel<_Document>
 */
fun Channel<_Document>.create(): Channel<_Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<_Document>
 */
fun Channel<_Document>.update(): Channel<_Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<_Document>
 */
fun Channel<_Document>.delete(): Channel<_Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<_Row>
 */
fun Channel<_Row>.create(): Channel<_Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<_Row>
 */
fun Channel<_Row>.update(): Channel<_Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<_Row>
 */
fun Channel<_Row>.delete(): Channel<_Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<_File>
 */
fun Channel<_File>.create(): Channel<_Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<_File>
 */
fun Channel<_File>.update(): Channel<_Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<_File>
 */
fun Channel<_File>.delete(): Channel<_Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<_Execution>
 */
fun Channel<_Execution>.create(): Channel<_Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<_Execution>
 */
fun Channel<_Execution>.update(): Channel<_Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<_Execution>
 */
fun Channel<_Execution>.delete(): Channel<_Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<_Team>
 */
fun Channel<_Team>.create(): Channel<_Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<_Team>
 */
fun Channel<_Team>.update(): Channel<_Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<_Team>
 */
fun Channel<_Team>.delete(): Channel<_Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<_Membership>
 */
fun Channel<_Membership>.create(): Channel<_Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<_Membership>
 */
fun Channel<_Membership>.update(): Channel<_Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<_Membership>
 */
fun Channel<_Membership>.delete(): Channel<_Resolved> =
    this.resolve("delete")

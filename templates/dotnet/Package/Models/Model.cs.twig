{% set DefinitionClass = definition.name | caseUcfirst | overrideIdentifier %}
using System;
using System.Linq;
using System.Collections.Generic;
using System.Text.Json;
using System.Text.Json.Serialization;
{% if definition.properties | filter(p => p.enum) | length > 0 %}
using {{ spec.title | caseUcfirst }}.Enums;
{% endif %}
using {{ spec.title | caseUcfirst }}.Extensions;

namespace {{ spec.title | caseUcfirst }}.Models
{
    public class {{ DefinitionClass }}
    {
        {%~ for property in definition.properties %}
        [JsonPropertyName("{{ property.name }}")]
        public {{ sub_schema(property) }} {{ property_name(definition, property) | overrideProperty(definition.name) }} { get; private set; }

        {%~ endfor %}
        {%~ if definition.additionalProperties %}
        public Dictionary<string, object> Data { get; private set; }

        {%~ endif %}
        public {{ DefinitionClass }}(
            {%~ for property in definition.properties %}
            {{ sub_schema(property) }} {{ property.name | caseCamel | escapeKeyword }}{% if not loop.last or (loop.last and definition.additionalProperties) %},{% endif %}

            {%~ endfor %}
            {%~ if definition.additionalProperties %}
            Dictionary<string, object> data
            {%~ endif %}
        ) {
            {%~ for property in definition.properties %}
            {{ property_name(definition, property) | overrideProperty(definition.name) }} = {{ property.name | caseCamel | escapeKeyword }};
            {%~ endfor %}
            {%~ if definition.additionalProperties %}
            Data = data;
            {%~ endif %}
        }

        public static {{ DefinitionClass }} From(Dictionary<string, object> map) => new {{ DefinitionClass }}(
            {%~ for property in definition.properties %}
            {{ property.name | caseCamel | escapeKeyword | removeDollarSign }}: {{ property | propertyAssignment | raw }}{% if not loop.last or (loop.last and definition.additionalProperties) %},{% endif %}

            {%~ endfor %}
            {%~ if definition.additionalProperties %}
            data: map.TryGetValue("data", out var dataValue) ? (Dictionary<string, object>)dataValue : map
            {%~ endif %}
        );

        public Dictionary<string, object?> ToMap() => new Dictionary<string, object?>()
        {
            {%~ for property in definition.properties %}
            { "{{ property.name }}", {{ property | toMapValue(definition.name) | raw }} }{% if not loop.last or (loop.last and definition.additionalProperties) %},{% endif %}

            {%~ endfor %}
            {%~ if definition.additionalProperties %}
            { "data", Data }
            {%~ endif %}
        };
        {%~ if definition.additionalProperties %}

        public T ConvertTo<T>(Func<Dictionary<string, object>, T> fromJson) =>
            fromJson.Invoke(Data);
        {%~ endif %}
        {%~ for property in definition.properties %}
        {%~ if property.sub_schema and not definition.additionalProperties %}
        {%~ for def in spec.definitions %}
        {%~ if def.name == property.sub_schema and def.additionalProperties and property.type == 'array' %}

        public T ConvertTo<T>(Func<Dictionary<string, object>, T> fromJson) =>
            (T){{ property.name | caseUcfirst | escapeKeyword }}.Select(it => it.ConvertTo(fromJson));

        {%~ endif %}
        {%~ endfor %}
        {%~ endif %}
        {%~ endfor %}
    }
}

using System.Collections.Generic;

namespace {{ spec.title | caseUcfirst }}
{
    /// <summary>
    /// The result of building the channel.
    /// </summary>
    public class ResolvedChannel
    {
        public string Value { get; }

        internal ResolvedChannel(string value)
        {
            Value = value;
        }

        public override string ToString() => Value;
    }

    // Helper function for normalizing ID
    internal static class ChannelHelper
    {
        internal static string Normalize(string id) => string.IsNullOrWhiteSpace(id) ? "*" : id.Trim();
    }

    // State interfaces
    public interface IActionable
    {
        ResolvedChannel Create();
        ResolvedChannel Update();
        ResolvedChannel Delete();
        string Channel { get; }
    }

    public interface IDatabase
    {
        ICollection Collection(string id = "*");
    }

    public interface ICollection
    {
        IDocument Document(string id = "*");
    }

    public interface IDocument : IActionable { }

    public interface ITablesDB
    {
        ITable Table(string id = "*");
    }

    public interface ITable
    {
        IRow Row(string id = "*");
    }

    public interface IRow : IActionable { }

    public interface IBucket
    {
        IFile File(string id = "*");
    }

    public interface IFile : IActionable { }

    public interface IFunction
    {
        IExecution Execution(string id = "*");
    }

    public interface IExecution : IActionable { }

    // Builder implementation
    internal class ChannelBuilder :
        IDatabase, ICollection, IDocument,
        ITablesDB, ITable, IRow,
        IBucket, IFile,
        IFunction, IExecution, IActionable
    {
        private readonly List<string> _segments;

        internal ChannelBuilder(List<string> segments)
        {
            _segments = segments;
        }

        private ChannelBuilder Next(string segment, string id)
        {
            var newSegments = new List<string>(_segments)
            {
                segment,
                ChannelHelper.Normalize(id)
            };
            return new ChannelBuilder(newSegments);
        }

        public ICollection Collection(string id = "*") => Next("collections", id);

        public IDocument Document(string id = "*") => Next("documents", id);

        public ITable Table(string id = "*") => Next("tables", id);

        public IRow Row(string id = "*") => Next("rows", id);

        public IFile File(string id = "*") => Next("files", id);

        public IExecution Execution(string id = "*") => Next("executions", id);

        public ResolvedChannel Create() => Resolve("create");

        public ResolvedChannel Update() => Resolve("update");

        public ResolvedChannel Delete() => Resolve("delete");

        public string Channel => string.Join(".", _segments);

        public override string ToString() => Channel;

        private ResolvedChannel Resolve(string action) => new ResolvedChannel($"{Channel}.{action}");
    }

    // Entry point
    public static class Channel
    {
        public static IDatabase Database(string id = "*") =>
            new ChannelBuilder(new List<string> { "databases", ChannelHelper.Normalize(id) });

        public static ITablesDB TablesDB(string id = "*") =>
            new ChannelBuilder(new List<string> { "tablesdb", ChannelHelper.Normalize(id) });

        public static IBucket Bucket(string id = "*") =>
            new ChannelBuilder(new List<string> { "buckets", ChannelHelper.Normalize(id) });

        public static IFunction Function(string id = "*") =>
            new ChannelBuilder(new List<string> { "functions", ChannelHelper.Normalize(id) });

        public static IActionable Team(string id = "*") =>
            new ChannelBuilder(new List<string> { "teams", ChannelHelper.Normalize(id) });

        public static IActionable Membership(string id = "*") =>
            new ChannelBuilder(new List<string> { "memberships", ChannelHelper.Normalize(id) });

        public static string Account(string userId = "")
        {
            var id = ChannelHelper.Normalize(userId);
            return id == "*" ? "account" : $"account.{id}";
        }

        // Global events (without ID)
        public static string Documents => "documents";
        public static string Rows => "rows";
        public static string Files => "files";
        public static string Executions => "executions";
    }
}

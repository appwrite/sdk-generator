import Client = require('./client');
import { globalConfig, localConfig } from './config';

export const sdkForConsole = async (requiresAuth: boolean = true): Promise<Client> => {
    const client = new Client();
    const endpoint = globalConfig.getEndpoint();
    const cookie = globalConfig.getCookie();
    const selfSigned = globalConfig.getSelfSigned();

    if (requiresAuth && cookie === '') {
        throw new Error('Session not found. Please run `{{ language.params.executableName }} login` to create a session');
    }

    client
        .setEndpoint(endpoint)
        .setCookie(cookie)
        .setProject('console')
        .setSelfSigned(selfSigned)
        .setLocale('en-US');

    return client;
};

export const sdkForProject = async (): Promise<Client> => {
    const client = new Client();
    const endpoint = localConfig.getEndpoint() || globalConfig.getEndpoint();
    const project = localConfig.getProject().projectId ? localConfig.getProject().projectId : globalConfig.getProject();
    const key = globalConfig.getKey();
    const cookie = globalConfig.getCookie();
    const selfSigned = globalConfig.getSelfSigned();

    if (!project) {
        throw new Error('Project is not set. Please run `{{ language.params.executableName }} init project` to initialize the current directory with an {{ spec.title|caseUcfirst }} project.');
    }

    client
        .setEndpoint(endpoint)
        .setProject(project)
        .setSelfSigned(selfSigned)
        .setLocale('en-US');

    if (cookie) {
        return client
{% if sdk.test != "true" %}
            .setCookie(cookie)
            .setMode('admin');
{% endif %}
    }

    if (key) {
        return client
{% if sdk.test != "true" %}
            .setKey(key)
            .setMode('default');
{% endif %}
    }

    throw new Error('Session not found. Please run `{{ language.params.executableName }} login` to create a session.');
};

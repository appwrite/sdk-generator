package {{ sdk.namespace | caseDot }}

// Marker interfaces for type safety
interface Root
interface Database
interface Collection
interface Document
interface TablesDB
interface Table
interface Row
interface Bucket
interface File
interface Func
interface Execution
interface Team
interface Membership
interface Resolved

// Union type for actionable channels
typealias Actionable = Document

/**
 * Helper for normalizing IDs
 */
private fun normalize(id: String): String {
    val trimmed = id.trim()
    return if (trimmed.isEmpty()) "*" else trimmed
}

/**
 * Channel class with generic type parameter for type-safe method chaining
 */
class Channel<out T> private constructor(
    private val segments: List<String>
) {
    /**
     * Internal helper to transition to next state with segment and ID
     * Public for extension function access
     */
    fun <N> next(segment: String, id: String = "*"): Channel<N> {
        return Channel(segments + listOf(segment, normalize(id)))
    }

    /**
     * Internal helper for terminal actions (no ID segment)
     * Public for extension function access
     */
    fun resolve(action: String): Channel<Resolved> {
        return Channel(segments + listOf(action))
    }

    /**
     * Convert channel to string representation
     */
    override fun toString(): String = segments.joinToString(".")

    companion object {
        fun database(id: String = "*"): Channel<Database> =
            Channel(listOf("databases", normalize(id)))

        fun tablesdb(id: String = "*"): Channel<TablesDB> =
            Channel(listOf("tablesdb", normalize(id)))

        fun bucket(id: String = "*"): Channel<Bucket> =
            Channel(listOf("buckets", normalize(id)))

        fun function(id: String = "*"): Channel<Func> =
            Channel(listOf("functions", normalize(id)))

        fun team(id: String = "*"): Channel<Team> =
            Channel(listOf("teams", normalize(id)))

        fun membership(id: String = "*"): Channel<Membership> =
            Channel(listOf("memberships", normalize(id)))

        fun account(userId: String = ""): String {
            val id = normalize(userId)
            return if (id == "*") "account" else "account.$id"
        }

        // Global events
        const val documents = "documents"
        const val rows = "rows"
        const val files = "files"
        const val executions = "executions"
    }
}

// --- DATABASE ROUTE ---
// Extension functions restricted by receiver type

/**
 * Only available on Channel<Database>
 */
fun Channel<Database>.collection(id: String = "*"): Channel<Collection> =
    this.next("collections", id)

/**
 * Only available on Channel<Collection>
 */
fun Channel<Collection>.document(id: String = "*"): Channel<Document> =
    this.next("documents", id)

// --- TABLESDB ROUTE ---

/**
 * Only available on Channel<TablesDB>
 */
fun Channel<TablesDB>.table(id: String = "*"): Channel<Table> =
    this.next("tables", id)

/**
 * Only available on Channel<Table>
 */
fun Channel<Table>.row(id: String = "*"): Channel<Row> =
    this.next("rows", id)

// --- BUCKET ROUTE ---

/**
 * Only available on Channel<Bucket>
 */
fun Channel<Bucket>.file(id: String = "*"): Channel<File> =
    this.next("files", id)

// --- FUNCTION ROUTE ---

/**
 * Only available on Channel<Func>
 */
fun Channel<Func>.execution(id: String = "*"): Channel<Execution> =
    this.next("executions", id)

// --- TERMINAL ACTIONS ---
// Restricted to Actionable types (Document, Row, File, Execution, Team, Membership)

/**
 * Only available on Channel<Document>
 */
fun Channel<Document>.create(): Channel<Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<Document>
 */
fun Channel<Document>.update(): Channel<Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<Document>
 */
fun Channel<Document>.delete(): Channel<Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<Row>
 */
fun Channel<Row>.create(): Channel<Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<Row>
 */
fun Channel<Row>.update(): Channel<Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<Row>
 */
fun Channel<Row>.delete(): Channel<Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<File>
 */
fun Channel<File>.create(): Channel<Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<File>
 */
fun Channel<File>.update(): Channel<Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<File>
 */
fun Channel<File>.delete(): Channel<Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<Execution>
 */
fun Channel<Execution>.create(): Channel<Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<Execution>
 */
fun Channel<Execution>.update(): Channel<Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<Execution>
 */
fun Channel<Execution>.delete(): Channel<Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<Team>
 */
fun Channel<Team>.create(): Channel<Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<Team>
 */
fun Channel<Team>.update(): Channel<Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<Team>
 */
fun Channel<Team>.delete(): Channel<Resolved> =
    this.resolve("delete")

/**
 * Only available on Channel<Membership>
 */
fun Channel<Membership>.create(): Channel<Resolved> =
    this.resolve("create")

/**
 * Only available on Channel<Membership>
 */
fun Channel<Membership>.update(): Channel<Resolved> =
    this.resolve("update")

/**
 * Only available on Channel<Membership>
 */
fun Channel<Membership>.delete(): Channel<Resolved> =
    this.resolve("delete")

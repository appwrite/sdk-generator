const { localConfig, globalConfig } = require('./config');
const { sdkForConsole } = require('./sdks');
const { projectsList } = require('./commands/projects');
const { functionsListRuntimes } = require('./commands/functions');

const questionsInitProject = [
  {
    type: "confirm",
    name: "override",
    message:
      `An Appwrite project ( ${localConfig.getProject()['projectName']} ) is already associated with the current directory. Would you like to override`,
    when() {
      return Object.keys(localConfig.getProject()).length !== 0;
    }
  },
  {
    type: "list",
    name: "start",
    when(answers) {
      if (answers.override == undefined) {
        return true 
      }
      return answers.override;
    },
    message: "How would you like to start?",
    choices: [
      {
        name: "Create a new Appwrite project",
        value: "new",
      },
      {
        name: "Link this directory to an existing Appwrite project",
        value: "existing",
      },
    ],
  },
  {
    type: "input",
    name: "project",
    message: "What would you like to name your project?",
    default: "My Awesome Project",
    when(answers) {
      return answers.start == "new";
    },
  },
  {
    type: "list",
    name: "project",
    message: "Choose your Appwrite project.",
    when(answers) {
      return answers.start == "existing";
    },
    choices: async () => {
      let response = await projectsList({
        parseOutput: false
      })
      let projects = response["projects"]
      let choices = projects.map((project, idx) => {
        return {
          name: `${project.name} (${project['$id']})`,
          value: {
            name: project.name,
            id: project['$id']
          }
        }
      })
      return choices;
    }
  }
];

const questionsInitFunction = [
  {
    type: "input",
    name: "name",
    message: "What would you like to name your function?",
    default: "My Awesome Function"
  },
  {
    type: "list",
    name: "runtime",
    message: "What runtime would you like to use?",
    choices: async () => {
      let response = await functionsListRuntimes({
        parseOutput: false
      })
      let runtimes = response["runtimes"]
      let choices = runtimes.map((runtime, idx) => {
        return {
          name: `${runtime.name} (${runtime['$id']})`,
          value: runtime['$id']
        }
      })
      return choices;
    }
  }
];

const questionsLogin = [
  {
    type: "input",
    name: "email",
    message: "Enter your email",
    validate(value) {
      if (!value) {
        return "Please enter your email";
      }
      return true;
    },
  },
  {
    type: "password",
    name: "password",
    message: "Enter your password",
    mask: "*",
    validate(value) {
      if (!value) {
        return "Please enter your password";
      }
      return true;
    }
  },
];

const questionsDeployFunctions = [
  {
    type: "checkbox",
    name: "functions",
    message: "Which functions would you like to deploy?",
    choices: () => {
      let functions = localConfig.getFunctions();
      if (functions.length === 0) {
        throw new Error("No functions found in the current directory. Run `appwrite init function` to initialise a new function");
      }
      let choices = functions.map((func, idx) => {
        return {
          name: `${func.name} (${func['$id']})`,
          value: func
        }
      })
      return choices;
    }
  }
  
]

const questionsGetCommand = [
  {
    type: "input",
    name: "command",
    message: "Enter the entrypoint command",
    default: null,
    validate(value) {
      if (!value) {
        return "Please enter your enrtypoint command";
      }
      return true;
    }
  },
]

module.exports = {
  questionsInitProject,
  questionsLogin,
  questionsInitFunction,
  questionsDeployFunctions,
  questionsGetCommand
};
